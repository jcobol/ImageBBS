# Iteration 47 – BASIC masked-pane staging map

## Goals
- [x] Audit the recovered BASIC listings for masked-pane producers that feed `tempbott+40`/`var_4078`.
- [x] Catalogue the macro payloads staged prior to each `&,50` flush so host tooling can mirror the glyph/colour queues.

## Findings

### `setup` overlay produces no masked-pane writes
- The boot overlay clears the screen, seeds CIA/Kernal state, and loads the REL/ML files (`E.I.MACRO`, `E.I.PROMPT`, `E.AMAINT`, `LBSETUP`, `E.LOG`, `ML.RS232`, `ML.PMODES`) without ever calling `&,50`. Its ampersand usage is limited to mode toggles (`&,18,0`) and flag updates inside the `LBSETUP` loop (`FOR X=0 TO 31: &,2,2: &,52,X,VAL(A$)`), all of which return directly to BASIC once the flags are latched.【F:v1.2/source/setup.bas†L80-L134】
- Every direct `POKE` in the startup path targets VIC/SID/I/O registers (`53248`, `53258`, `52935`–`52938`, `56328`–`56331`) rather than `$4028-$404F/$4078-$409F`, so the overlay never back-fills the masked-pane staging spans before control transfers to the main dispatcher.【F:v1.2/source/setup.bas†L66-L146】 The producer therefore cannot live in `setup`; the masked pane only rotates once `im` begins staging macros.

### Main dispatcher staging sequences
- The `im` dispatcher preps the masked pane by chaining `&,28` with `&,52,21,3`, fetching the next macro record (`GOSUB 1011`), and then issuing a bare `&`—the implicit `&,50`—to hand the staged glyphs to `outscn` and `loopb94e`.【F:v1.2/core/im.txt†L1813-L1814】【F:docs/porting/iteration-41.md†L9-L24】 Each entry to the file-transfer menu restages the same sequence so the ROM print that follows the prompt swap consumes the queued payload immediately.
- Error handling follows the same pattern. The invalid-selection branch restages the header (`IFF4 THEN :&,28`), toggles sayings and prompt flags (`&,52,5,3` / `&,52,20,3`), and concludes with another bare `&` so the refreshed macro slots replace the masked pane without any direct writes into `$4028/$4078`.【F:v1.2/core/im.txt†L1842-L1852】 The macro toggles cover both the sayings banner and the “unknown command” overlay, keeping staging entirely within the ampersand helpers.
- The editor setup loop continues the history captured in the original note: once `&,52,31,3` seeds the masked-pane offsets, the code drops into `&,54` and immediately executes another bare ampersand after the prompt print so the refreshed buffers flow through `loopb94e` without any manual `$4028/$4078` writes.【F:v1.2/core/im.txt†L1599-L1615】 This keeps the staging semantics consistent across the dispatcher, editor, and file-transfer modules.

### Macro payloads and colour queues
- `MLExtraDefaults` exposes the flag-dispatch table that maps the `&,52` indices above to their macro slots: `$04/$09/$0D` (main-menu header, prompt, invalid strip) and `$14-$19` (sysop sayings/prompt toggles).【F:docs/porting/artifacts/ml-extra-overlay-metadata.json†L81-L117】 The recovered macro screens show slots `$04` and `$09` as the two-line banner and prompt rendered in light-red (`$0A`) glyphs over the orange (`$08`) masked-pane background, with `$0D` providing the reverse-video strip reused for invalid selections.【F:docs/porting/artifacts/ml-extra-macro-screens.json.gz.base64†L1-L1】
- Slots `$14-$19` are single-byte macros that repaint the sayings/prompt cells with the same `$0A/$08` palette, mirroring the BASIC toggles that reset the prompt before each bare ampersand flush.【F:docs/porting/artifacts/ml-extra-overlay-metadata.json†L88-L117】【F:docs/porting/artifacts/ml-extra-macro-screens.json.gz.base64†L1-L1】 Because the overlay supplies these payloads, the host can recover the exact glyph/colour pairs from the defaults table instead of translating BASIC text at runtime.
- The additional macro payloads mirrored in `_EXTRA_MACRO_PAYLOADS` cover the file-transfer overlay: slot `$28` carries the six-line menu, `$29` stores the “COMMAND (Q TO EXIT):” prompt, and `$2A` contains “?? UNKNOWN COMMAND,” all encoded in the same `$0A` foreground on `$08` background that the masked pane expects.【F:scripts/prototypes/ml_extra_defaults.py†L20-L156】【F:docs/porting/artifacts/ml-extra-macro-screens.json.gz.base64†L1-L1】 These slots match the `&,28` staging sequence in `im` and the modern runtime’s `ConsoleService.stage_masked_pane_overlay` plumbing.【F:v1.2/core/im.txt†L1813-L1814】【F:docs/porting/iteration-45.md†L18-L34】

### Implications for the host runtime
- The BASIC listings confirm iteration 44’s hypothesis: masked-pane producers live entirely on the BASIC side via macro staging, with no inline `POKE`s refilling `tempbott+40`/`var_4078`. Every flush is triggered by the bare ampersand that routes back to `outscn`, so host tooling must cache the macro payloads before invoking the rotation loop.【F:docs/porting/iteration-44.md†L9-L23】【F:v1.2/core/im.txt†L1813-L1852】
- Because the macro slots are static and the flush timing matches `loopb94e`, the host implementation can preload the glyph/colour matrices from `MLExtraDefaults` (including the supplemental `_EXTRA_MACRO_PAYLOADS`) and stage them ahead of any `&,50` dispatch. The console shim already exposes `stage_macro_slot` and `stage_masked_pane_overlay`; wiring these helpers to the staging map above keeps host rotations aligned with the C64 overlay.【F:scripts/prototypes/ml_extra_defaults.py†L20-L156】【F:docs/porting/iteration-46.md†L16-L20】

### Host runtime integration
- The runtime now derives a canonical staging map via `ConsoleService.masked_pane_staging_map`, backed by the `masked_pane_staging` helper that enumerates flag slots, BASIC ampersand producers, and the sysop fallback overlays so staging stays consistent with iteration 47’s findings.【F:scripts/prototypes/device_context.py†L740-L835】【F:scripts/prototypes/runtime/masked_pane_staging.py†L1-L170】
- Menu dispatchers (`MainMenuModule`, `FileTransfersModule`, and `SysopOptionsModule`) call `render_masked_macro` with the shared map instead of hard-coded slot numbers, guaranteeing that each `&,28`/`&,52` producer queues the correct payload before `ConsoleService.commit_masked_pane_staging` runs.【F:scripts/prototypes/runtime/main_menu.py†L1-L170】【F:scripts/prototypes/runtime/file_transfers.py†L1-L220】【F:scripts/prototypes/runtime/sysop_options.py†L1-L220】

## Next steps
- Thread the iteration-47 staging map through the host masked-pane helpers so each bare `&` (the implicit `&,50`) receives the queued glyphs/colours before committing the swap.
- Update the console tests to assert that macros `$04/$09/$0D`, `$14-$19`, and `$28-$2A` are staged prior to `&,50`, reusing the matrices recorded here to guard against regressions when new overlays are decoded.
